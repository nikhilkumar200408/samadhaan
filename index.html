<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMADHAAN | Govt of Delhi Oversight</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0c10;
            --card: #1f2833;
            --saffron: #ff9933;
            --green: #138808;
            --white: #ffffff;
            --blue: #45a29e;
            --danger: #ff0000;
            --text-mute: #c5c6c7;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg);
            color: var(--white);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* HEADER */
        header {
            background: linear-gradient(90deg, #1f2833 0%, #000 100%);
            padding: 15px 40px;
            border-bottom: 3px solid var(--saffron);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo h1 { margin: 0; font-size: 2rem; letter-spacing: 2px; }
        .logo span { color: var(--saffron); }
        .sub-logo { font-size: 0.9rem; color: var(--text-mute); letter-spacing: 1px; }

        /* LIVE TICKER */
        .ticker-wrap {
            width: 100%;
            background-color: #000;
            color: var(--green);
            font-family: monospace;
            font-size: 0.9rem;
            padding: 5px 0;
            border-bottom: 1px solid #333;
            white-space: nowrap;
            overflow: hidden;
        }
        .ticker { display: inline-block; animation: marquee 20s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* MAIN LAYOUT */
        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--card);
            border-radius: 5px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border-top: 2px solid var(--blue);
        }

        h3 { margin-top: 0; color: var(--blue); text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* FORMS */
        label { display: block; margin-top: 15px; color: var(--text-mute); font-size: 0.9rem; }
        input, select {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            background: #0b0c10;
            border: 1px solid #444;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            box-sizing: border-box;
        }
        input:focus, select:focus { border-color: var(--saffron); outline: none; }

        button {
            width: 100%;
            margin-top: 25px;
            padding: 15px;
            background: var(--saffron);
            color: black;
            font-weight: bold;
            font-size: 1.2rem;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
        }
        button:hover { background: #ffbd69; }

        /* RESULTS */
        .result-panel {
            display: none;
            background: #000;
            padding: 20px;
            margin-top: 20px;
            border: 1px dashed #444;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        .safe { background: rgba(19, 136, 8, 0.2); color: var(--green); border: 1px solid var(--green); }
        .danger { background: rgba(255, 0, 0, 0.2); color: var(--danger); border: 1px solid var(--danger); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .check-list div { margin-bottom: 5px; font-size: 0.9rem; }
        .check-pass { color: var(--green); }
        .check-fail { color: var(--danger); }

        /* LEDGER */
        .ledger-box {
            grid-column: span 2;
            height: 300px;
            overflow-y: auto;
            background: #000;
            padding: 10px;
            border: 1px solid #333;
        }
        .log-entry {
            display: grid;
            grid-template-columns: 0.5fr 1fr 1fr 1fr 2fr;
            padding: 10px;
            border-bottom: 1px solid #222;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-mute);
        }
        .log-entry:hover { background: #111; color: var(--white); }
        .hash { color: var(--saffron); overflow: hidden; text-overflow: ellipsis; }

    </style>
</head>
<body>

    <header>
        <div class="logo">
            <h1>SAMADHAAN <span>AI</span></h1>
            <div class="sub-logo">Intelligent Public Procurement Oversight | Govt of NCT Delhi</div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 1.5rem; font-weight: bold;">üáÆüá≥</div>
            <div style="font-size: 0.8rem; color: #888;">SECURE CONNECTION</div>
        </div>
    </header>

    <div class="ticker-wrap">
        <div class="ticker">
            System Online... Monitoring 4 Departments... PWD Delhi Server: Active... NDMC Server: Active... Jal Board: Syncing... Last Fraud Prevented: ‚Çπ2.5 Cr in Sector 14 Dwarka...
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h3>Start Investigation</h3>
            
            <label>Department</label>
            <select id="department">
                <option value="PWD Delhi">Public Works Department (PWD)</option>
                <option value="NDMC">New Delhi Municipal Council</option>
                <option value="Delhi Jal Board">Delhi Jal Board</option>
                <option value="DoE">Directorate of Education</option>
                <option value="Transport">Transport Department</option>
            </select>

            <label>Vendor / Contractor Name</label>
            <input type="text" id="vendor" placeholder="e.g. Sharma Infra Pvt Ltd">

            <label>Tender Amount (‚Çπ INR)</label>
            <input type="number" id="amount" placeholder="e.g. 2500000">

            <button onclick="analyze()">Verify Transaction</button>
        </div>

        <div class="card">
            <h3>Real-Time Analysis Dashboard</h3>
            
            <div id="defaultMsg" style="text-align: center; color: #555; margin-top: 50px;">
                <p style="font-size: 3rem;">üìä</p>
                <p>Waiting for input stream...</p>
            </div>

            <div id="resultPanel" class="result-panel">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <span id="statusBadge" class="status-badge">ANALYZING...</span>
                        <h1 id="displayAmount" style="margin: 5px 0;">‚Çπ0.00</h1>
                        <div style="color: #888; font-size: 0.9rem;">Vendor: <span id="displayVendor" style="color: white;">-</span></div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: bold;" id="riskScore">0%</div>
                        <div style="font-size: 0.8rem;">RISK PROBABILITY</div>
                    </div>
                </div>

                <hr style="border-color: #333; margin: 20px 0;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4 style="margin-top: 0; color: var(--blue);">AI Vetting Checks</h4>
                        <div class="check-list">
                            <div id="checkGST">‚è≥ GST Registration Check</div>
                            <div id="checkPAN">‚è≥ PAN Database Linkage</div>
                            <div id="checkHist">‚è≥ Vendor History Analysis</div>
                            <div id="checkBlk">‚è≥ Blacklist Database Scan</div>
                        </div>
                    </div>
                    <div id="blockchainSection" style="display: none;">
                        <h4 style="margin-top: 0; color: var(--saffron);">Blockchain Evidence</h4>
                        <p style="font-size: 0.8rem; color: #888;">This transaction has been flagged and permanently recorded in the immutable ledger.</p>
                        <div style="background: #111; padding: 10px; font-family: monospace; font-size: 0.7rem; color: var(--saffron); word-break: break-all;">
                            HASH: <span id="txHash"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card ledger-box">
            <h3>Immutable Audit Ledger (Blockchain Node)</h3>
            <div style="display: grid; grid-template-columns: 0.5fr 1fr 1fr 1fr 2fr; font-weight: bold; color: var(--blue); padding: 0 10px; margin-bottom: 10px;">
                <div>ID</div>
                <div>TIMESTAMP</div>
                <div>DEPT</div>
                <div>AMOUNT</div>
                <div>HASH</div>
            </div>
            <div id="ledgerContent">
                </div>
        </div>
    </div>

    <script>
        async function analyze() {
            const vendor = document.getElementById('vendor').value;
            const amount = document.getElementById('amount').value;
            const dept = document.getElementById('department').value;
            
            const resultPanel = document.getElementById('resultPanel');
            const defaultMsg = document.getElementById('defaultMsg');

            if(!vendor || !amount) { alert("Please enter all details."); return; }

            // Show Loading
            defaultMsg.style.display = 'none';
            resultPanel.style.display = 'block';
            document.getElementById('statusBadge').className = 'status-badge';
            document.getElementById('statusBadge').innerText = "RUNNING AI MODELS...";
            document.getElementById('statusBadge').style.background = "#333";
            document.getElementById('statusBadge').style.color = "white";

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vendor: vendor, amount: amount, department: dept })
                });
                const data = await response.json();
                const res = data.result;

                // Simulate "Thinking" time for effect
                setTimeout(() => {
                    // Update Main Display
                    document.getElementById('displayAmount').innerText = res.amount;
                    document.getElementById('displayVendor').innerText = res.vendor;
                    document.getElementById('riskScore').innerText = res.risk_score + "%";

                    // Update Status Badge
                    const badge = document.getElementById('statusBadge');
                    if (res.risk_level === "CRITICAL") {
                        badge.innerText = "‚ö†Ô∏è FRAUD DETECTED";
                        badge.className = "status-badge danger";
                        document.getElementById('blockchainSection').style.display = 'block';
                        document.getElementById('txHash').innerText = data.blockchain_hash;
                    } else {
                        badge.innerText = "‚úÖ VERIFIED SAFE";
                        badge.className = "status-badge safe";
                        document.getElementById('blockchainSection').style.display = 'none';
                    }

                    // Update Checks
                    document.getElementById('checkGST').innerHTML = (res.checks.gst_valid === "TRUE" ? "‚úÖ" : "‚ùå") + " GST Registration Check";
                    document.getElementById('checkPAN').innerHTML = "‚úÖ PAN Database Linkage";
                    document.getElementById('checkHist').innerHTML = (res.risk_score > 50 ? "‚ùå" : "‚úÖ") + " Vendor History Analysis";
                    document.getElementById('checkBlk').innerHTML = (res.checks.blacklist_check === "CLEAN" ? "‚úÖ" : "‚ùå") + " Blacklist Database Scan";

                    fetchLedger();
                }, 1000);

            } catch (error) {
                console.error("Error:", error);
                alert("Backend not connected.");
            }
        }

        async function fetchLedger() {
            const response = await fetch('/ledger');
            const chain = await response.json();
            const ledgerDiv = document.getElementById('ledgerContent');
            
            ledgerDiv.innerHTML = "";
            chain.slice(1).reverse().forEach(block => {
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `
                    <div>#${block.index}</div>
                    <div>${block.timestamp.split(' ')[3]}</div>
                    <div>${block.data.department}</div>
                    <div style="color:white;">${block.data.amount}</div>
                    <div class="hash">${block.hash}</div>
                `;
                ledgerDiv.appendChild(div);
            });
        }
        
        fetchLedger();
    </script>
</body>
</html>